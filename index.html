<script>
    const MY_API_KEY = "7142915ec1dc45caad56dfc9fcf07341";
    const BASE_US_MCAP = 62.5; 
    const BASE_KR_MCAP = 4660; 
    let live = { k:0, kp:0, u:0, up:0, y10:0, y10p:0, y2:0, y2p:0 };

    // 프록시 서버 목록 (첫 번째가 안되면 두 번째로 시도하도록 보강)
    async function fetchData(url) {
        const proxies = [
            `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
            `https://corsproxy.io/?${encodeURIComponent(url)}`
        ];
        
        for (const proxy of proxies) {
            try {
                const res = await fetch(proxy);
                const data = await res.json();
                // allorigins는 응답이 문자열로 올 수 있어 처리 필요
                return typeof data.contents === 'string' ? JSON.parse(data.contents) : (data.contents || data);
            } catch (e) { continue; }
        }
        return null;
    }

    function formatChange(c, p, id) {
        const diff = c - p, pct = (diff/p*100).toFixed(2);
        const sign = diff > 0 ? "▲" : diff < 0 ? "▼" : "";
        const cls = diff > 0 ? "up" : diff < 0 ? "down" : "";
        const cEl = document.getElementById(id + "-c");
        if(cEl) {
            cEl.innerHTML = `<span class="${cls}">${sign} ${Math.abs(diff).toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2})} (${pct}%)</span>`;
        }
    }

    async function getYahoo(ticker, id) {
        try {
            // 야후 파이낸스 데이터 호출
            const data = await fetchData(`https://query1.finance.yahoo.com/v8/finance/chart/${ticker}?interval=1m&range=1d`);
            
            if (data && data.chart && data.chart.result) {
                const meta = data.chart.result[0].meta;
                const cur = meta.regularMarketPrice;
                const prev = meta.previousClose;
                renderValue(id, cur, prev, ticker);
            } else {
                // 야후 실패 시 Twelve Data로 한 번 더 시도 (보험)
                fetchTwelveFallback(ticker, id);
            }
        } catch (err) { 
            console.error(id + " 로드 실패"); 
        }
    }

    // 데이터 렌더링 로직 (기존 자릿수 조절 로직 그대로 보존)
    function renderValue(id, cur, prev, ticker) {
        const el = document.getElementById(id);
        if (!el) return;

        let displayVal = "";
        if (id === "SILVER" || id === "XRP") {
            displayVal = cur.toFixed(3);
        } else if (id === "US30Y" || id === "US10Y" || id === "US2Y") {
            displayVal = cur.toFixed(2) + "%";
        } else {
            displayVal = cur.toLocaleString(undefined, {minimumFractionDigits:2, maximumFractionDigits:2});
        }
        
        el.innerText = displayVal;
        formatChange(cur, prev, id);

        // 특수 지표 연산 유지
        if (id === "VIX") {
            if (cur >= 30) el.className = "value status-danger";
            else if (cur >= 20) el.className = "value status-warning";
            else el.className = "value status-safe";
        }
        if(id === "KOSPI") { live.k=cur; live.kp=prev; updateKrMcap(cur, prev); }
        if(id === "US10Y") { live.y10=cur; live.y10p=prev; updateSpread(); }
        if(id === "US2Y") { live.y2=cur; live.y2p=prev; updateSpread(); }
        if(ticker === "VTI") updateUsMcap(cur, prev);
        updateKospiUsd();
    }

    // 야후 차단 대비 보조 함수
    async function fetchTwelveFallback(ticker, id) {
        const symbolMap = { "^GSPC":"SPX", "^IXIC":"IXIC", "BTC-USD":"BTC/USD" };
        const sym = symbolMap[ticker] || ticker;
        try {
            const res = await fetch(`https://api.twelvedata.com/quote?symbol=${sym}&apikey=${MY_API_KEY}`);
            const d = await res.json();
            if(d && d.close) renderValue(id, parseFloat(d.close), parseFloat(d.previous_close), ticker);
        } catch(e) {}
    }

    function updateUsMcap(c, p) {
        const m = BASE_US_MCAP * (c/p);
        const el = document.getElementById("US_MCAP");
        if(el) {
            el.innerText = m.toFixed(2);
            formatChange(m, BASE_US_MCAP, "US_MCAP");
            const bft = (m/27.94*100).toFixed(1);
            const bEl = document.getElementById("BUFFETT");
            if(bEl) { 
                bEl.innerText = bft + "%"; 
                bEl.className = "value " + (bft>=150?"status-danger":bft>=120?"status-warning":"status-safe"); 
            }
        }
    }

    function updateKrMcap(c, p) {
        const m = BASE_KR_MCAP * (c/p);
        const el = document.getElementById("KR_MCAP");
        if(el) { el.innerText = Math.floor(m).
